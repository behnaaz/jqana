<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Lcom4Listener.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jqana</a> &gt; <a href="index.html" class="el_package">com.obomprogramador.tools.jqana.parsers</a> &gt; <span class="el_source">Lcom4Listener.java</span></div><h1>Lcom4Listener.java</h1><pre class="source lang-java linenums">
/**
 * jQana - Open Source Java(TM) code quality analyzer.
 * 
 * Copyright 2013 Cleuton Sampaio de Melo Jr
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * 
 * Project website: http://www.jqana.com
 */
package com.obomprogramador.tools.jqana.parsers;

import java.util.Arrays;
import java.util.List;

import org.antlr.v4.runtime.ParserRuleContext;
import org.antlr.v4.runtime.misc.NotNull;
import org.antlr.v4.runtime.tree.ParseTree;
import org.antlr.v4.runtime.tree.ParseTreeWalker;
import org.antlr.v4.runtime.tree.TerminalNodeImpl;
import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.obomprogramador.tools.jqana.antlrparser.JavaBaseListener;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser.AnnotationContext;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser.ClassDeclarationContext;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser.CompilationUnitContext;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser.ExpressionContext;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser.FieldDeclarationContext;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser.FormalParametersContext;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser.LocalVariableDeclarationContext;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser.LocalVariableDeclarationStatementContext;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser.MethodBodyContext;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser.MethodDeclarationContext;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser.PackageDeclarationContext;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser.StatementContext;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser.VariableDeclaratorContext;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser.VariableDeclaratorIdContext;
import com.obomprogramador.tools.jqana.antlrparser.JavaParser.VariableDeclaratorsContext;
import com.obomprogramador.tools.jqana.model.Measurement;
import com.obomprogramador.tools.jqana.model.defaultimpl.GetClassNameFromContext;

import com.obomprogramador.tools.jqana.parsers.Member.MEMBER_TYPE;

/**
 * Implementation of JavaBaseListener (ANTLR4) that checks LCOM4 value for a class.
 * 
 * How does it work?
 * It creates a class' members array, containing each method or variable. For each method, 
 * the listener verifies any of its references, for example: referenced methods and variables, and so on.
 * This array is returned to the parser, that calculated LCOM4.
 * 
 * It classifies each class member according to its MEMBER_TYPE.
 * @see GobalConstants.MEMBER_TYPE
 * 
 *  
 * @author Cleuton Sampaio.
 *
 */
public class Lcom4Listener extends JavaBaseListener {

	protected Logger logger;
	protected List&lt;Member&gt; membersTable;
	protected JavaParser parser;
<span class="fc" id="L77">	protected String [] prefixos = {&quot;get&quot;, &quot;set&quot;, &quot;is&quot;, &quot;has&quot;};</span>
<span class="fc" id="L78">	protected List&lt;String&gt;getterSetterPrefix = Arrays.asList(prefixos);</span>
	protected String mainPackageName;
	public String mainClassName;
	protected boolean alreadyGotMainClass;
	protected boolean overrideAnnotation;
	
<span class="fc" id="L84">	public Lcom4Listener(List&lt;Member&gt; members, JavaParser p) {</span>
<span class="fc" id="L85">		this.logger = LoggerFactory.getLogger(this.getClass());</span>
<span class="fc" id="L86">		this.membersTable = members;</span>
<span class="fc" id="L87">		this.parser = p;</span>
<span class="fc" id="L88">	}</span>

	

	@Override
	public void enterClassDeclaration(@NotNull ClassDeclarationContext ctx) {
<span class="fc bfc" id="L94" title="All 2 branches covered.">		if (!alreadyGotMainClass) {</span>
<span class="fc" id="L95">			mainClassName = GetClassNameFromContext.getClassName(ctx);</span>
<span class="fc" id="L96">			alreadyGotMainClass = true;</span>
		}
		

<span class="fc" id="L100">	}</span>



	@Override
	public void enterPackageDeclaration(@NotNull PackageDeclarationContext ctx) {
<span class="fc" id="L106">		mainPackageName = ctx.getText().substring(7);</span>
<span class="fc" id="L107">		logger.debug(mainPackageName);;</span>
<span class="fc" id="L108">	}</span>



	/**
	 * Get the field's name, which is a tricky task.
	 */
	@Override
	public void enterFieldDeclaration(@NotNull FieldDeclarationContext ctx) {
<span class="fc" id="L117">		String name = &quot;&quot;;</span>
		
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">		for (ParseTree subTree : ctx.children) {</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">			if (subTree instanceof VariableDeclaratorsContext) {</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">				for (ParseTree st2 : ((VariableDeclaratorsContext) subTree).children) {</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">					if (st2 instanceof VariableDeclaratorContext) {</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">						for (ParseTree st3 : ((VariableDeclaratorContext) st2).children) {</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">							if (st3 instanceof VariableDeclaratorIdContext) {</span>
<span class="fc" id="L125">								name = st3.getText();</span>
<span class="pc" id="L126">								break;</span>
							}
						}
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">						if (name.length() &gt; 0) {</span>
<span class="fc" id="L130">							break;</span>
						}
					}
<span class="nc bnc" id="L133" title="All 2 branches missed.">					if (name.length() &gt; 0) {</span>
<span class="nc" id="L134">						break;</span>
					}
				}
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">				if (name.length() &gt; 0) {</span>
<span class="fc" id="L138">					break;</span>
				}
			}
		}
<span class="fc" id="L142">		Member member = new Member();</span>
<span class="fc" id="L143">		member.className = mainClassName;</span>
<span class="fc" id="L144">		member.name = name;</span>
<span class="fc" id="L145">		member.packageName = this.mainPackageName;</span>
<span class="fc" id="L146">		member.type = MEMBER_TYPE.VARIABLE;</span>
<span class="fc" id="L147">		this.membersTable.add(member);</span>
<span class="fc" id="L148">	}</span>


	
	
	@Override
	public void enterAnnotation(@NotNull AnnotationContext ctx) {
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">		if (ctx.getText().equals(&quot;@Override&quot;)) {</span>
<span class="fc" id="L156">			this.overrideAnnotation = true;</span>
		}
<span class="fc" id="L158">	}</span>



	/**
	 * We add each method to the members array. Then we will check for references.
	 */
	@Override
	public void enterMethodDeclaration(@NotNull MethodDeclarationContext ctx) {
<span class="fc" id="L167">		String methodName = &quot;&lt;no name&gt;&quot;;</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">		for (ParseTree subTree : ctx.children) {</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">			if (subTree instanceof TerminalNodeImpl) {</span>
<span class="fc" id="L170">				methodName = subTree.toString();</span>
			}
<span class="fc bfc" id="L172" title="All 2 branches covered.">			else if (subTree instanceof FormalParametersContext) {</span>
<span class="fc" id="L173">				break;</span>
			}
		}
		
<span class="fc" id="L177">		ParseTree body = null;</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">		for (ParseTree subTree : ctx.children) {</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">			if (subTree instanceof MethodBodyContext) {</span>
<span class="fc" id="L180">				body = subTree;</span>
<span class="fc" id="L181">				break;</span>
			}
		}
		
<span class="fc bfc" id="L185" title="All 2 branches covered.">		if (this.overrideAnnotation) {</span>
<span class="fc" id="L186">			logger.debug(&quot;*** Inherited method ignored: &quot; + methodName);</span>
		}
		else {
<span class="fc" id="L189">			logger.debug(&quot;- Method found: &quot; + methodName);</span>
<span class="fc" id="L190">			Member member = new Member();</span>
<span class="fc" id="L191">			member.className = mainClassName;</span>
<span class="fc" id="L192">			member.name = methodName;</span>
<span class="fc" id="L193">			member.packageName = this.mainPackageName;</span>
<span class="fc" id="L194">			member.type = MEMBER_TYPE.METHOD;</span>
<span class="fc" id="L195">			member.body = body;</span>
<span class="fc" id="L196">			this.membersTable.add(member);			</span>
		}

<span class="fc" id="L199">		this.overrideAnnotation = false;</span>
<span class="fc" id="L200">	}</span>
	
	/**
	 * This is a special inner listener, used to check for a method's references.
	 * @author Cleuton Sampaio
	 *
	 */
	class Lcom4MethodListener extends JavaBaseListener {
		private Member member;
<span class="fc" id="L209">		public Lcom4MethodListener(Member member) {</span>
<span class="fc" id="L210">			this.member = member;</span>
<span class="fc" id="L211">		}</span>
		
		/**
		 * We have to check any expression, looking for other methods and variables references.
		 */
		@Override
		public void enterExpression(@NotNull ExpressionContext ctx) {
<span class="fc bfc" id="L218" title="All 2 branches covered.">			if (ctx.children.size() == 1) {</span>
<span class="fc" id="L219">				String exprMember = ctx.getText();</span>
<span class="fc" id="L220">				logger.debug(&quot;Expression Member: &quot; + exprMember);	</span>
<span class="fc" id="L221">				Member nMember = new Member();</span>
<span class="fc" id="L222">				member.className = mainClassName;</span>
<span class="fc" id="L223">				member.packageName = mainPackageName;</span>
<span class="fc" id="L224">				nMember.name = exprMember;</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">				if (membersTable.contains(nMember)) {</span>
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">					if (!member.referencedMembers.contains(exprMember)) {</span>
<span class="fc" id="L227">						int indx = membersTable.indexOf(nMember);</span>
<span class="fc" id="L228">						nMember = membersTable.get(indx);</span>
<span class="fc bfc" id="L229" title="All 2 branches covered.">						if (nMember.type == MEMBER_TYPE.GETTER_SETTER) {</span>
<span class="fc" id="L230">							member.referencedMembers.add(nMember.targetVariable);</span>
						}
						else {
<span class="fc" id="L233">							member.referencedMembers.add(nMember);	</span>
						}
<span class="fc" id="L235">						logger.debug(&quot;Class Member reference added: &quot; + exprMember);</span>
					}
				}
			}
<span class="fc" id="L239">		}</span>
		
		

	}

	/**
	 * Now, that we finished analysing the class, we need to verify each found method's referencies.
	 * So, we instantiate our special listener and walk each method's tree.
	 */
	@Override
	public void exitCompilationUnit(@NotNull CompilationUnitContext ctx) {
		
<span class="fc bfc" id="L252" title="All 2 branches covered.">		for (Member m : this.membersTable) {</span>
<span class="fc" id="L253">			ParseTreeWalker walker = new ParseTreeWalker();</span>
<span class="fc bfc" id="L254" title="All 2 branches covered.">			if (m.type == MEMBER_TYPE.METHOD) {</span>
<span class="fc bfc" id="L255" title="All 2 branches covered.">				if (checkForGetterSetter(m)) {</span>
<span class="fc" id="L256">					m.type = MEMBER_TYPE.GETTER_SETTER;</span>
				}
				else {
<span class="fc" id="L259">			        Lcom4MethodListener ml = new Lcom4MethodListener(m);</span>
<span class="fc" id="L260">			        walker.walk(ml, m.body); </span>
				}
			}
<span class="fc" id="L263">		}</span>
		
<span class="fc" id="L265">		System.out.println(&quot;FIM&quot;);</span>
<span class="fc" id="L266">	}</span>


	private boolean checkForGetterSetter(Member m) {
<span class="fc" id="L270">		boolean isGetterSetter = false;</span>
<span class="fc bfc" id="L271" title="All 2 branches covered.">		for (Member n : this.membersTable) {</span>
<span class="fc bfc" id="L272" title="All 2 branches covered.">			if (n.type == MEMBER_TYPE.VARIABLE) {</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">				if (StringUtils.containsIgnoreCase(m.name, n.name)) {</span>
					//StringUtils.strip(&quot;  abcyx&quot;, &quot;xyz&quot;) = &quot;  abc&quot;
<span class="fc" id="L275">					String beginMethodName = StringUtils.stripEnd(m.name.toLowerCase(), n.name.toLowerCase());</span>
<span class="fc bfc" id="L276" title="All 2 branches covered.">					if (this.getterSetterPrefix.contains(beginMethodName)) {</span>
<span class="fc" id="L277">						isGetterSetter = true;</span>
<span class="fc" id="L278">						m.targetVariable = n;</span>
					}
					break;
				}
			}
		}
<span class="fc" id="L284">		return isGetterSetter;</span>
	}
	


}
</pre><div class="footer"><span class="right">Created with <a href="http://jacoco.org">JaCoCo</a> 0.5.3.201107060350</span></div></body></html>