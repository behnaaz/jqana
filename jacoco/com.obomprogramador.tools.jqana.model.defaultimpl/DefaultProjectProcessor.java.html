<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DefaultProjectProcessor.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jqana</a> &gt; <a href="index.html" class="el_package">com.obomprogramador.tools.jqana.model.defaultimpl</a> &gt; <span class="el_source">DefaultProjectProcessor.java</span></div><h1>DefaultProjectProcessor.java</h1><pre class="source lang-java linenums">package com.obomprogramador.tools.jqana.model.defaultimpl;



import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.URISyntaxException;
import java.util.ResourceBundle;

import javax.xml.bind.JAXBException;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.TransformerException;

import org.apache.commons.io.FileUtils;
import org.apache.maven.plugin.logging.Log;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.obomprogramador.tools.jqana.context.Context;
import com.obomprogramador.tools.jqana.model.Measurement;
import com.obomprogramador.tools.jqana.model.Measurement.MEASUREMENT_TYPE;
import com.obomprogramador.tools.jqana.model.Parser;
import com.obomprogramador.tools.jqana.model.ProjectProcessor;
import com.obomprogramador.tools.jqana.parsers.CyclomaticComplexityParser;
import com.obomprogramador.tools.jqana.parsers.Lcom4Parser;
import com.obomprogramador.tools.jqana.parsers.RfcBcelParser;
import com.obomprogramador.tools.jqana.parsers.RfcParser;

public class DefaultProjectProcessor implements ProjectProcessor {

	protected Context context;
	protected File projectSourceRoot;
	protected File projectObjectRoot;
	protected String currentFolderName;
	protected Measurement project;
	protected Logger logger;
	protected Log log;
<span class="pc" id="L42">	protected enum MSG_TYPE {INFO, DEBUG, ERROR};</span>
	
	
	public Log getLog() {
<span class="nc" id="L46">		return log;</span>
	}

	public void setLog(Log log) {
<span class="fc" id="L50">		this.log = log;</span>
<span class="fc" id="L51">	}</span>

	public DefaultProjectProcessor(Context context) {
<span class="fc" id="L54">		super();</span>
<span class="fc" id="L55">		this.context = context;</span>
<span class="fc" id="L56">		this.logger = LoggerFactory.getLogger(this.getClass());</span>
<span class="fc" id="L57">	}</span>

	@Override
	public Measurement process(String projectName, File projectSourceRoot, File projectObjectRoot) throws URISyntaxException, IOException, JAXBException, ParserConfigurationException, TransformerException, ClassNotFoundException, InstantiationException, IllegalAccessException {
<span class="fc" id="L61">		this.projectSourceRoot = projectSourceRoot;</span>
<span class="fc" id="L62">		this.projectObjectRoot = projectObjectRoot;</span>
<span class="fc" id="L63">		this.project = new Measurement();</span>
<span class="fc" id="L64">		this.project.setName(projectName);</span>
<span class="fc" id="L65">		this.project.setType(MEASUREMENT_TYPE.PROJECT_MEASUREMENT);</span>
		
<span class="fc" id="L67">		logMsg(&quot;**** Project: &quot; + projectName + &quot;, resources: &quot; + projectSourceRoot.getPath(), MSG_TYPE.DEBUG);</span>
		try {
<span class="fc" id="L69">			processFolder(this.projectSourceRoot);</span>
			
<span class="nc" id="L71">		} catch (ClassNotFoundException e) {</span>
<span class="nc" id="L72">			logger.error(e.getMessage());</span>
<span class="nc" id="L73">			throw(e);</span>
<span class="nc" id="L74">		} catch (InstantiationException e) {</span>
<span class="nc" id="L75">			logger.error(e.getMessage());</span>
<span class="nc" id="L76">			throw(e);</span>
<span class="nc" id="L77">		} catch (IllegalAccessException e) {</span>
<span class="nc" id="L78">			logger.error(e.getMessage());</span>
<span class="nc" id="L79">			throw(e);</span>
<span class="fc" id="L80">		}</span>
		
<span class="fc" id="L82">		updatePackagesAggregates();</span>

<span class="fc" id="L84">		return this.project;</span>
	}
	

	protected void updatePackagesAggregates() {
<span class="fc bfc" id="L89" title="All 2 branches covered.">		for (Measurement m : this.project.getInnerMeasurements()) {</span>
<span class="fc" id="L90">			MetricValue mv = m.getMetricValue(this.context.getBundle().getString(&quot;metric.cc.name&quot;));</span>
<span class="fc" id="L91">			mv.setValue((double)mv.getValue() / (double)mv.getQtdElements());</span>
<span class="fc" id="L92">			mv = m.getMetricValue(this.context.getBundle().getString(&quot;metric.rfc.name&quot;));</span>
<span class="fc" id="L93">			mv.setValue((double)mv.getValue() / (double)mv.getQtdElements());</span>
<span class="fc" id="L94">		}</span>
		
<span class="fc" id="L96">	}</span>

	/* (non javadoc)
	 * Process each package and add it's measurement to the project's measurement.
	 * 
	 */
	protected void processFolder(File sourceDir) throws ClassNotFoundException, InstantiationException, IllegalAccessException {
<span class="fc" id="L103">		boolean hasJavaFiles = false;</span>
<span class="fc" id="L104">		File [] listFiles = sourceDir.listFiles();</span>
<span class="fc" id="L105">		Measurement packageMeasurement = new Measurement();</span>
<span class="fc" id="L106">		packageMeasurement.setName(getPackageName(sourceDir));</span>
<span class="fc" id="L107">		packageMeasurement.setType(MEASUREMENT_TYPE.PACKAGE_MEASUREMENT);</span>
<span class="fc" id="L108">		logMsg(&quot;**** Pagkage: &quot; + sourceDir.getName(), MSG_TYPE.DEBUG);</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">		for (int x=0; x&lt;listFiles.length; x++) {</span>
<span class="fc" id="L110">			File oneFile = listFiles[x];</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">			if (oneFile.isFile()) {</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">				if (isJavaFile(oneFile)) {</span>
<span class="fc" id="L113">					hasJavaFiles = true;</span>
				}
<span class="fc" id="L115">				processMetrics(packageMeasurement,oneFile);</span>
			}
			else {
				// Is a directory (sub package)
<span class="fc" id="L119">				processFolder(oneFile);</span>
			}
		}
<span class="fc bfc" id="L122" title="All 2 branches covered.">		if (hasJavaFiles) {</span>
			// if this package has java files, then we add it to the project's measurements
<span class="fc" id="L124">			project.getInnerMeasurements().add(packageMeasurement);</span>
			
		}
		
<span class="fc" id="L128">	}</span>
	
	protected String getPackageName(File sourceDir) {
<span class="fc" id="L131">		String packageName = null;</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">		if (sourceDir.getName().equalsIgnoreCase(&quot;java&quot;)) {</span>
<span class="fc" id="L133">			packageName = &quot;&lt;default&gt;&quot;;</span>
		}
		else {
<span class="fc" id="L136">			int inx = sourceDir.getPath().indexOf(&quot;java\\&quot;);</span>
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">			if (inx &lt; 0) {</span>
<span class="nc" id="L138">				inx = sourceDir.getPath().indexOf(&quot;java/&quot;);</span>
			}
<span class="fc" id="L140">			packageName = sourceDir.getPath().substring(inx + 5);</span>
<span class="fc" id="L141">			packageName = packageName.replace(&quot;\\&quot;, &quot;.&quot;);</span>
<span class="fc" id="L142">			packageName = packageName.replace(&quot;/&quot;, &quot;.&quot;);</span>
		}
<span class="fc" id="L144">		return packageName;</span>
	}

	protected boolean isJavaFile(File oneFile) {
<span class="fc" id="L148">		boolean returnCode = false;</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">		if (FileUtils.getExtension(oneFile.getName()).equalsIgnoreCase(&quot;java&quot;)) {</span>
<span class="fc" id="L150">			returnCode = true;</span>
		}
<span class="fc" id="L152">		return returnCode;</span>
	}

	/* (non javadoc)
	 * Process the metric set for each source file.
	 * 
	 */
	protected void processMetrics(Measurement packageMeasurement, File oneFile) throws ClassNotFoundException, InstantiationException, IllegalAccessException {
<span class="fc" id="L160">		logger.debug(&quot;Source file: &quot; + oneFile.getName());</span>
<span class="fc" id="L161">		String sourceCode = this.getSource(oneFile);</span>
<span class="fc" id="L162">		processCyclomaticMetric(sourceCode, packageMeasurement);</span>
<span class="fc" id="L163">		processLcom4Metric(sourceCode, packageMeasurement);</span>
<span class="fc" id="L164">		processRfcMetric(oneFile, packageMeasurement);</span>
<span class="fc" id="L165">	}</span>
	
	/* (non javadoc)
	 * Analyzes Cyclomatic complexity for a source file.
	 */
	protected void processCyclomaticMetric(String sourceFile, Measurement packageMeasurement) throws ClassNotFoundException, InstantiationException, IllegalAccessException {
		
<span class="fc" id="L172">		Context context = new Context();</span>
<span class="fc" id="L173">		ResourceBundle bundle = ResourceBundle.getBundle(&quot;report&quot;);</span>
<span class="fc" id="L174">		context.setBundle(bundle);</span>
<span class="fc" id="L175">		Parser parser = new CyclomaticComplexityParser(packageMeasurement, context);</span>
<span class="fc" id="L176">		Measurement mt = parser.parse( null, sourceFile);</span>
		
<span class="fc" id="L178">	}</span>
	
	/* (non javadoc)
	 * Analyzes LCOM4 for a source file.
	 */
	protected void processLcom4Metric(String sourceFile, Measurement packageMeasurement) throws ClassNotFoundException, InstantiationException, IllegalAccessException {
<span class="fc" id="L184">		Context context = new Context();</span>
<span class="fc" id="L185">		ResourceBundle bundle = ResourceBundle.getBundle(&quot;report&quot;);</span>
<span class="fc" id="L186">		context.setBundle(bundle);</span>
<span class="fc" id="L187">		Parser parser = new Lcom4Parser(packageMeasurement, context);</span>
<span class="fc" id="L188">		Measurement mt = parser.parse( null, sourceFile);</span>
<span class="fc" id="L189">		logger.debug(mt.toString());</span>
<span class="fc" id="L190">	}</span>
	
	/* (non javadoc)
	 * Analyzes RFC for a source file.
	 * 
	 */
	protected void processRfcMetric(File oneFile, Measurement packageMeasurement) throws ClassNotFoundException, InstantiationException, IllegalAccessException {
<span class="fc" id="L197">		Context context = new Context();</span>
<span class="fc" id="L198">		String objectPath = getObjectFilePath(oneFile);</span>
<span class="fc" id="L199">		ResourceBundle bundle = ResourceBundle.getBundle(&quot;report&quot;);</span>
<span class="fc" id="L200">		context.setBundle(bundle);</span>
<span class="fc" id="L201">		Parser parser = new RfcBcelParser(packageMeasurement, context);</span>
<span class="fc" id="L202">		Measurement mt = parser.parse(objectPath, null);</span>
		
<span class="fc" id="L204">	}</span>
	
	protected String getObjectFilePath(File oneFile) {
<span class="fc" id="L207">		String objectPath = oneFile.getPath().replace(&quot;.java&quot;, &quot;.class&quot;);</span>
<span class="fc" id="L208">		objectPath = objectPath.replace(this.projectSourceRoot.getPath(), this.projectObjectRoot.getPath());</span>
<span class="fc" id="L209">		return objectPath;</span>
	}

	protected String getSource(File oneFile) {
<span class="fc" id="L213">		BufferedReader br = null;</span>
<span class="fc" id="L214">	    StringBuilder sb = new StringBuilder();</span>
	    try {
<span class="fc" id="L216">	    	br = new BufferedReader(new InputStreamReader(new FileInputStream(oneFile),&quot;UTF-8&quot;));</span>
<span class="fc" id="L217">	        String line = br.readLine();</span>

<span class="fc bfc" id="L219" title="All 2 branches covered.">	        while (line != null) {</span>
<span class="fc" id="L220">	            sb.append(line);</span>
<span class="fc" id="L221">	            sb.append(&quot;\n&quot;);</span>
<span class="fc" id="L222">	            line = br.readLine();</span>
	        }
<span class="fc" id="L224">	        return sb.toString();</span>
<span class="nc" id="L225">	    } catch (IOException e) {</span>
<span class="nc" id="L226">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L228">	        try {</span>
<span class="pc" id="L229">				br.close();</span>
<span class="nc" id="L230">			} catch (IOException e) {</span>
<span class="nc" id="L231">				e.printStackTrace();</span>
<span class="pc" id="L232">			}</span>
<span class="nc" id="L233">	    }</span>
<span class="nc" id="L234">	    return sb.toString();		</span>
	}

	protected InputStream getStream(String sourceFile) {
<span class="nc" id="L238">		return this.getClass().getClassLoader().getResourceAsStream(sourceFile);</span>
	}
	


	  protected void logMsg(String msg, MSG_TYPE type) {
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">		  if (this.log == null) {</span>
			  // using internal logger
<span class="pc bnc" id="L246" title="All 4 branches missed.">			  switch (type) {</span>
			  case INFO:
<span class="nc" id="L248">				  logger.info(msg);</span>
<span class="nc" id="L249">				  break;</span>
			  case DEBUG:
<span class="nc" id="L251">				  logger.debug(msg);</span>
<span class="nc" id="L252">				  break;</span>
			  case ERROR:
<span class="nc" id="L254">				  logger.error(msg);</span>
			  }
		  }
		  else {
			  // using maven plugin logger
<span class="pc bpc" id="L259" title="3 of 4 branches missed.">			  switch (type) {</span>
			  case INFO:
<span class="nc" id="L261">				  this.log.info(msg);</span>
<span class="nc" id="L262">				  break;</span>
			  case DEBUG:
<span class="fc" id="L264">				  this.log.debug(msg);</span>
<span class="fc" id="L265">				  break;</span>
			  case ERROR:
<span class="nc" id="L267">				  this.log.error(msg);</span>
			  }
		  }
<span class="fc" id="L270">	  }</span>
	  
}
</pre><div class="footer"><span class="right">Created with <a href="http://jacoco.org">JaCoCo</a> 0.5.3.201107060350</span></div></body></html>